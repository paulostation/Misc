#INCLUDE <P16F628A.INC>	;ARQUIVO PADRÃO MICROCHIP PARA 16F628A
	__CONFIG _BODEN_ON & _CP_OFF & _PWRTE_ON & _WDT_OFF & _WDT_OFF & _LVP_OFF & _MCLRE_OFF & _INTRC_OSC_NOCLKOUT

#DEFINE		BANK0	BCF STATUS,RP0	;SETA BANK0 DE MEMÓRIA
#DEFINE		BANK1	BSF	STATUS,RP0	;SETA BANK1 DE MEMÓRIA

;-------------------DEFINICOES DE BOTOES-------------------------;
#DEFINE		BOTAO_START		PORTA,2		;BOTAO DE START NA ROTINA CONFIGURACAO
#DEFINE		BOTAO_INC		PORTA,4		;BOTAO DE INCREMENTO
#DEFINE		BOTAO_DEC		PORTA,6		;BOTAO DE DECREMENTO
#DEFINE		CLEAR 			PORTA,5		;BOTAO PARA RESETAR A CONFIGURACAO
;-------------------DEFINICOES DE PINOS--------------------------; 
#DEFINE		RELAY			PORTA,7		;PINO ONDE SE ENCONTRA O TRANSISTOR QUE LIGA O ACIONADOR DO RELAY
#DEFINE		LED_CONFIG		PORTA,0		;LED QUE SINALIZA O MODO DE CONFIGURACAO
#DEFINE		LED_EXE			PORTA,1		;LED QUE SINALIZA O MODO DE EXECUCAO
#DEFINE		SENSOR			PORTA,3		;PINO QUE RECEBE O SINAL DO SENSOR DE CORRENTE
;-------------------DEFINICOES DE FLAGS--------------------------;
#DEFINE 	MODE 			FLAGS,0		;SINALIZA O MODO EM QUE O PIC ESTA, 0 PARA EXECUCAO E 1 PARA CONFIGURACAO
#DEFINE		VALOR_MUDOU		FLAGS,4

CBLOCK	0x20					
;CBLOCK EH O ENDEREÇO INICIAL DA MEMÓRIA DE USUÁRIO EH AQUI QUE CRIAMOS AS VARIAVEIS (REGISTRADORES)

	REG_UNI			;VARIAVEL QUE GUARDA O VALOR DO DISPLAY DE UNIDADE
	REG_DEZ			;VARIAVEL QUE GUARDA O VALOR DO DISPLAY DE DEZENA
	TEMPO_CHUVEIRO	;REGISTRADOR DE TEMPO PARA NOSSO REGISTRADOR QUE DECREMENTA E INCREMENTA VARIAVEL NO TEMPO NOMINAL DO ACIONAMENTO DO RELAY
	FLAGS			;REGISTRADOR ONDE SAO GUARDADAS AS FLAGS

;----------------------------------------------------------------------------------------------------------------------------REGISTRADORES USADOS EM ROTINAS DE DELAY---------------------------;
	TEMP2			
	TEMP3	
	TEMP4	
	TEMP5
	TEMP6

;---------------------------------------------------------------------------------------------------------------------------------FIM DO BLOCO DE MEMÓRIA DE USUARIO----------------------------;
ENDC	

;----------------------------------------------------------------------------------------------------------------ENDEREÇO INICIAL DE PROCESSAMENTO, O PROGRAMA COMECA A SER RODADO DAQUI--------;	
	ORG 0x00					
	
	BANK0
	MOVLW	B'00000111'
	MOVWF	CMCON
	
	BANK1
	;CONFIGURA ENTRADAS E SAIDAS DO PORT A
	MOVLW	B'01111100'
	MOVWF	TRISA
	;CONFIGURA ENTRADAS E SAIDAS DO PORT A
	MOVLW	B'00000000'
	MOVWF	TRISB
	;SEI LA O QUE CONFIGURA
	MOVLW	B'10000100'
	MOVWF	OPTION_REG
	;CONFIGURA REGISTRADOR DE INTERRUPCOES
	MOVLW	B'00000000'
	MOVWF	INTCON

	BANK0
;----------------------------------------------------------------------------------------------------------------------------------VALOR PADRAO DE TODAS AS VARIAVEIS---------------------------;
	BSF		VALOR_MUDOU
	CLRF	REG_DEZ
	CLRF	PORTA
	CLRF	PORTB
	CLRF	FLAGS
	CLRF	TEMP2
	CLRF	TEMP3	
	CLRF	TEMP4
	CLRF	TEMP5
	CLRF	TEMP6
	MOVLW	.30
	MOVWF	TEMPO_CHUVEIRO
	CLRF	REG_UNI
	MOVLW	.3
	MOVWF	REG_DEZ
	GOTO	MAIN

;-----------------------------------------------------------------------------------------------------------------------------------------ROTINA DE DELAY 1SEGUNDO------------------------------;	
_DL2
	MOVLW	.4
	MOVWF	TEMP4
	;TEMP4 = 4;

_DL3
	MOVLW	.250
	MOVWF	TEMP5
	;TEMP5 = 250;
_DL4
	MOVLW	.200
	MOVWF	TEMP6
	;TEMP6 = 200;
_DL5
	NOP
	NOP	
	DECFSZ	TEMP6,F
	GOTO	_DL5	
	DECFSZ	TEMP5,F	
	GOTO	_DL4
	DECFSZ	TEMP4,F
	GOTO	_DL3
	RETURN
;-------------------------------------------------------------------------------------------------------------------------------------------ROTINA DE DELAY 10SEGUNDOS----------------------------;
DELAY10S	

	MOVLW	.40
	MOVWF	TEMP4
	
_DELAY250mS
	MOVLW	.250
	MOVWF	TEMP5

_DELAY200uS
	MOVLW	.200
	MOVWF	TEMP6

_DELAY5uS
	NOP
	NOP
	DECFSZ	TEMP6,F
	GOTO	_DELAY5uS
	DECFSZ	TEMP5,F	
	GOTO	_DELAY200uS
	DECFSZ	TEMP4,F
	GOTO	_DELAY250mS
	RETURN
;----------------------------------------------------------------------------------------------------------------------------------------ROTINA DE DELAY PRINCIPAL-----------------------------;

DELAY

	MOVF	TEMPO_CHUVEIRO,W
	MOVWF	TEMP3
	
	;TEMP3 = 2

DL2

	;MOVE 3 PARA COMPARAR COM O TEMP2 PARA LIGAR O LED
	MOVLW	.5
	XORWF	TEMP3,W
	BTFSS	STATUS,Z
	;SE O TESTE FOR 0 LIGA O LED_EXE, SE 1 CONTINUA A COMPARAÇAO
	GOTO	$ + 2
	BSF		LED_EXE
	
	MOVLW	.4
	MOVWF	TEMP4
	
	

DL3
	MOVLW	.250
	MOVWF	TEMP5

DL4
	MOVLW	.200
	MOVWF	TEMP6

DL5	
	NOP
	NOP	
	DECFSZ	TEMP6,F
	GOTO	DL5	
	DECFSZ	TEMP5,F	
	GOTO	DL4
	DECFSZ	TEMP4,F
	GOTO	DL3
	DECFSZ	TEMP3,F
	GOTO	DL2
	
	RETURN
;---------------------------------------------------------------------------------------------------------------------------------------------------ROTINA DE LIMPEZA---------------------------;
CLEAR_CONFIG

	CLRF	REG_UNI
	MOVLW	.1
	MOVWF	REG_UNI
	CLRF	TEMPO_CHUVEIRO
	MOVLW	.1
	MOVWF	TEMPO_CHUVEIRO
	CLRF	REG_DEZ
	BCF		RELAY
	RETURN
;------------------------------------------------------------------------------------------------------------ROTINA DE INCREMENTO NO REGISTRADOR REG_UNI E TEMPO_CHUVEIRO-----------------------;
INCREMENTO
	
	;SETA A FLAG DE MUDANCA DE VALOR
	BSF		VALOR_MUDOU
	;TESTA SE A UNIDADE EH 9
	MOVLW	.9
	XORWF	REG_UNI,W
	BTFSS	STATUS,Z
	;SE ESTIVER EM 9, ZERA UNIDADE E INCREMENTA DEZENA
	GOTO	CASO_UNIDADE_NAO_EH_9
	MOVLW	.9
	XORWF	REG_DEZ,W
	BTFSS	STATUS,Z
	GOTO	SOMENTE_UNIDADE_EH_9
	;SE DEZENA E UNIDADE EH 9, ZERA OS DOIS CONTADORES E O REGISTRADOR DE CONTROLE DO DELAY DO CHUVEIRO
	CLRF	REG_UNI
	CLRF	REG_DEZ
	CLRF	TEMPO_CHUVEIRO
	RETURN

	SOMENTE_UNIDADE_EH_9
	;SOMENTE A UNIDADE E 9 ENTAO ZERA A UNIDADE E INCREMENTA A DEZENA E O REGISTRADOR DE CONTROLE DO DELAY DO CHUVEIRO
	MOVLW	.0
	MOVWF	REG_UNI
	INCF	REG_DEZ,F
	INCF	TEMPO_CHUVEIRO,F
	RETURN

	CASO_UNIDADE_NAO_EH_9
	;SE NAO ESTIVER EM 9, APENAS INCREMENTA A UNIDADE
	INCF	TEMPO_CHUVEIRO,F
	INCF	REG_UNI,F
	RETURN

	
;------------------------------------------------------------------------------------------------------------ROTINA DE DECREMENTO NO REGISTRADOR REG_DEZ E TEMPO_CHUVEIRO-----------------------;
DECREMENTO

	;SETA A FLAG DE MUDANCA DE VALOR 
	BSF		VALOR_MUDOU
	;TESTA SE O VALOR ATUAL DO REGISTRADOR DE UNIDADE EH ZERO
	MOVLW	.0
	XORWF	REG_UNI,W
	BTFSS	STATUS,Z
	GOTO CASO_UNIDADE_NAO_SEJA_0	
	GOTO CASO_UNIDADE_SEJA_0
	
	CASO_UNIDADE_NAO_SEJA_0	
	;SE A UNIDADE NAO EH ZERO, APENAS DECREMENTA UNIDADE E O REGISTRADOR DE CONTROLE DO DELAY DO CHUVEIRO
	DECF	REG_UNI,F
	DECF	TEMPO_CHUVEIRO,F
	RETURN

	;SE FOR 0, TESTA SE A DEZENA TAMBEM EH ZERO
	CASO_UNIDADE_SEJA_0
	MOVLW	.0
	XORWF	REG_DEZ,W
	BTFSS	STATUS,Z
	;SE NAO FOR, CONTINUA
	GOTO	$ + 2
	;SE FOR, VAI PARA OUTRA OCASIAO
	GOTO	CASO_OS_DOIS_SEJAM_ZERO
	;COMO SO A UNIDADE EH ZERO, UNIDADE = 9,DEZENA DECREMENTA E O REGISTRADOR DE CONTROLE DO CHUVEIRO TAMBEM
	MOVLW	.9
	MOVWF	REG_UNI
	DECF	REG_DEZ,F
	DECF	TEMPO_CHUVEIRO,F
	RETURN
	
	CASO_OS_DOIS_SEJAM_ZERO
	;COMO OS DOIS SAO ZERO, UNIDADE = 9 E DEZENA = 9 E TEMPO_CHUVEIRO = 99
	MOVLW	.9
	MOVWF	REG_UNI
	MOVLW	.9
	MOVWF	REG_DEZ
	MOVLW	.99
	MOVWF	TEMPO_CHUVEIRO
	RETURN
	
;---------------------------------------------------------------------------------------------------------------------------------------------ROTINA PRINCIPAL----------------------------------; 
MAIN
	CALL 	ATUALIZA
	BTFSS	BOTAO_START
	GOTO 	EXECUCAO
	GOTO 	CONFIGURACAO
;--------------------------------------------------------------------------------------------------------------------------------------------ROTINA DE EXECUCAO---------------------------------;	
EXECUCAO
	
	;SINALIZA QUE ESTA NA ROTINA DE EXECUAO
	BCF		LED_CONFIG
	BSF		LED_EXE

	;TESTA SE FOI APERTADO O BOTAO DE CONFIGURACAO
	BTFSS	BOTAO_START
	GOTO 	$ + 5
	;ESPERA QUE O BOTAO SEJA SOLTO
	BTFSS	BOTAO_START
	GOTO	$ + 2
	GOTO	$ - 2
	GOTO	CONFIGURACAO


	;TESTA SE O SENSOR DETECTOU CORRENTE
	BTFSS	SENSOR
	;SE NAO, VOLTA PRO INICIO DA ROTINA DE EXECUCAO
	GOTO	EXECUCAO       							    
 	;SE SIM, COMECA O DELAY
	BCF		LED_EXE
	CALL	DELAY	
	BSF		RELAY
	;TEMPO DE COOLDOWN
	CALL	DELAY10S
	BCF		RELAY
	GOTO	EXECUCAO





	;MOSTRA O ESTADO DE FUNCIONAMENTO COM O LED DE EXECUCAO
	BSF		LED_EXE
	;TESTA O PINO DO SENSOR, NAO IRA CONTINUAR A ROTINA SE CASO O SENSOR NAO SER SETADO EM 1
	BTFSS	SENSOR
	GOTO	$ - 2
	;INICIO DA ROTINA DE DELAY ESTIPULADA NA CONFIGURACAO
	CALL	DELAY
	;AO TERMINO DO DELAY, ELE INDICA COM OS DOIS LEDS LIGADOS O TEMPO FALTA 5MIN PARA FEXAR O CIRCUITO DE POTENCIA
	BSF		LED_EXE
	BSF		LED_CONFIG
	;DEPOIS TEMOS O TEMPO DE ESPERA ANTES DE DESLIGAR O CIRCUITO DE POTENCIA
	;CALL	DELAY5S
	;LIGA O PINO ONDE ESTA LIGADO O CIRCUITO DE POTENCIA, FEXANDO O CIRCUITO
	BSF		RELAY
	;TESTA O BOTAO DE START, SE FOR 0, VOLTA PRA EXECUCAO REPETINDO O MESMO CICLO DE ACIONAMENTO
	GOTO	CONFIGURACAO		
	
;--------------------------------------------------------------------------------------------------------------------------------------------ROTINA DE CONFIGURACAO-----------------------------;			
CONFIGURACAO
	;BOTAO CLEAR PARA APAGAR A CONFIGURACAO E RELFAZE-LA
	;BTFSS	CLEAR
	;GOTO	PASSO_0
	;CALL	CLEAR_CONFIG
	
	
	;TESTA NO MEIO DA ROTINA PARA DAR PARTIDA NO TIMER CONFORME A CONFIGURACAO
	;BTFSS	BOTAO_START
	;GOTO	PASSO_1
	;GOTO	EXECUCAO

	PASSO_1
	;SINALIZA QUE ESTÁ EM MODO DE CONFIGURAÇÃO
	BSF		LED_CONFIG
	BCF		LED_EXE

	PASSO_2
	;TESTA O BIT DO REGISTRADOR RA4 (BOTAO DE INCREMENTO)SE FOR UM ELE PULA UMA LINHA DA ROTINA
	BTFSS	BOTAO_INC
	GOTO 	PASSO_3
	;ESPERA QUE O BOTAO SEJA SOLTO
	BTFSS	BOTAO_INC
	GOTO	$ + 2
	GOTO	$ - 2
	CALL	INCREMENTO

	PASSO_3
	;TESTA O BIT DO REGISTRADOR RA6 (BOTAO DE DECREMENTO)SE FOR UM ELE PULA UMA LINHA DA ROTINA
	BTFSS	BOTAO_DEC
	GOTO 	PASSO_4
	;ESPERA QUE O BOTAO SEJA SOLTO
	BTFSS	BOTAO_DEC
	GOTO	$ + 2
	GOTO	$ - 2
	CALL	DECREMENTO	

	PASSO_4
	CALL	ATUALIZA
	
	PASSO_5

	BTFSS	BOTAO_START
	GOTO 	CONFIGURACAO
	;ESPERA QUE O BOTAO SEJA SOLTO
	BTFSS	BOTAO_START
	GOTO	$ + 2
	GOTO	$ - 2
	GOTO	EXECUCAO
			
ATUALIZA
	;ATUALIZA VALOR NO DISPLAY
	
	;TESTA SE ALGUMA MUDANCA OCORREU
	BTFSS	VALOR_MUDOU
	;SE NAO APENAS CONTINUA
	RETURN
	;SE SIM ZERA O PORTB PARA QUE SO SEJA NECESSARIO APLICAR MUDANCAS COM BIT = 1
	CLRF	PORTB

	;PRIMEIRA METADE = DISPLAY DA UNIDADE
	BTFSS	REG_UNI,0
	GOTO	$ + 2
	BSF		PORTB,0
	BTFSS	REG_UNI,1
	GOTO	$ + 2
	BSF		PORTB,1
	BTFSS	REG_UNI,2
	GOTO	$ + 2
	BSF		PORTB,2
	BTFSS	REG_UNI,3
	GOTO	$ + 2
	BSF		PORTB,3

	;SEGUNDA METADE = DISPLAY DA DEZENA
	BTFSS	REG_DEZ,0
	GOTO	$ + 2
	BSF		PORTB,4
	BTFSS	REG_DEZ,1
	GOTO	$ + 2
	BSF		PORTB,5
	BTFSS	REG_DEZ,2
	GOTO	$ + 2
	BSF		PORTB,6
	BTFSS	REG_DEZ,3
	GOTO	$ + 2
	BSF		PORTB,7
	;LIMPA A FLAG DE MUDANCA DE VALOR, POIS O VALOR FOI ATUALIZADO
	BCF		VALOR_MUDOU
	RETURN


	END