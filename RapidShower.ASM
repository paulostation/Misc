#INCLUDE <P16F628A.INC>	;MICROCHIP PIC16F628A DEFAULT INCLUDE FILE
	__CONFIG _BODEN_ON & _CP_OFF & _PWRTE_ON & _WDT_OFF & _WDT_OFF & _LVP_OFF & _MCLRE_OFF & _INTRC_OSC_NOCLKOUT

#DEFINE		BANK0	BCF STATUS,RP0	;SETS MEMORY BANK0
#DEFINE		BANK1	BSF	STATUS,RP0	;SETS MEMORY BANK1

;-------------------BUTTON DEFINES------------------------------------;
#DEFINE		MODE_BUTTON		PORTA,2		;MODE CHANGING BUTTON
#DEFINE		INC_BUTTON		PORTA,4		;INCREMENT BUTTON
#DEFINE		DEC_BUTTON		PORTA,6		;DECREMENT BUTTON

;-------------------PIN DEFINES---------------------------------------; 
#DEFINE		RELAY			PORTA,7		;PIN WHERE THE RELAY IS CONNECTED
#DEFINE		LED_CONFIG		PORTA,0		;LED THAT SIGNALS CONFIG MODE
#DEFINE		LED_RUN			PORTA,1		;LED THAT SIGNALS RUNNING MODE
#DEFINE		SENSOR			PORTA,3		;PIN WHERE THE CURRENT SENSOR IS CONNECTED
;-------------------FLAG DEFINES--------------------------------------;
#DEFINE 	MODE 			FLAGS,0		;USED TO DEFINE THE MODE (RUNNING OR CONFIGURATION)
#DEFINE		CHANGES_MADE	FLAGS,4		;SIGNALS THAT CHANGES WERE MADE AND A DISPLAY UPDATE IS NEEDED

CBLOCK	0x20					

	REG_UNI			;STORES UNIT DISPLAY VALUE
	REG_TENS			;STORES TENS DISPLAY VALUE
	TEMPO_CHUVEIRO	;CONTROLS RELAY DELAY TIME BY USING DISPLAY VALUE
	FLAGS			;FLAG REGISTER
	

;---------------------DELAY BASED REGISTERS---------------------------;
	TEMP2			
	TEMP3	
	TEMP4	
	TEMP5
	TEMP6

ENDC	

	ORG 0x00					
	
	BANK0
	MOVLW	B'00000111'
	MOVWF	CMCON
	
	BANK1
	;CONFIGURE PORT A I/O
	MOVLW	B'01111100'
	MOVWF	TRISA
	;CONFIGURE PORT B I/O
	MOVLW	B'00000000'
	MOVWF	TRISB
	MOVLW	B'10000100'
	MOVWF	OPTION_REG
	;CONFIGURE INTERRUPTIONS REGISTER
	MOVLW	B'00000000'
	MOVWF	INTCON

	BANK0
;--------------------------------------VARIABLES DEFAULT VALUES---------------------------;
	BSF		CHANGES_MADE
	CLRF	REG_TENS
	CLRF	PORTA
	CLRF	PORTB
	CLRF	FLAGS
	CLRF	TEMP2
	CLRF	TEMP3	
	CLRF	TEMP4
	CLRF	TEMP5
	CLRF	TEMP6
	MOVLW	.30
	MOVWF	TEMPO_CHUVEIRO
	CLRF	REG_UNI
	MOVLW	.3
	MOVWF	REG_TENS
	GOTO	MAIN

;-------------------------------------1 SECOND DELAY ROUTINE------------------------------;	
_DL2
	MOVLW	.4
	MOVWF	TEMP4
	;TEMP4 = 4;

_DL3
	MOVLW	.250
	MOVWF	TEMP5
	;TEMP5 = 250;
_DL4
	MOVLW	.200
	MOVWF	TEMP6
	;TEMP6 = 200;
_DL5
	NOP
	NOP	
	DECFSZ	TEMP6,F
	GOTO	_DL5	
	DECFSZ	TEMP5,F	
	GOTO	_DL4
	DECFSZ	TEMP4,F
	GOTO	_DL3
	RETURN
;-------------------------------------10 SECOND DELAY ROUTINE------------------------------;	
DELAY10S	

	MOVLW	.40
	MOVWF	TEMP4
	
_DELAY250mS
	MOVLW	.250
	MOVWF	TEMP5

_DELAY200uS
	MOVLW	.200
	MOVWF	TEMP6

_DELAY5uS
	NOP
	NOP
	DECFSZ	TEMP6,F
	GOTO	_DELAY5uS
	DECFSZ	TEMP5,F	
	GOTO	_DELAY200uS
	DECFSZ	TEMP4,F
	GOTO	_DELAY250mS
	RETURN
;-------------------------------------MAIN DELAY ROUTINE------------------------------;	

DELAY

	MOVF	TEMPO_CHUVEIRO,W
	MOVWF	TEMP3

DL2

	;CHECK IF TEMP3 VALUE EQUALS 5 TO SIGNAL THAT TIME IS RUNNING OUT
	MOVLW	.5
	XORWF	TEMP3,W
	BTFSS	STATUS,Z
	;IF SO, TURN ON LED_RUN
	GOTO	$ + 2
	BSF		LED_RUN
	
	MOVLW	.4
	MOVWF	TEMP4
	
DL3
	MOVLW	.250
	MOVWF	TEMP5

DL4
	MOVLW	.200
	MOVWF	TEMP6

DL5	
	NOP
	NOP	
	DECFSZ	TEMP6,F
	GOTO	DL5	
	DECFSZ	TEMP5,F	
	GOTO	DL4
	DECFSZ	TEMP4,F
	GOTO	DL3
	DECFSZ	TEMP3,F
	GOTO	DL2
	
	RETURN
;----------------------------------INC AND DEC ROUTINES-----------------------;
INCREMENTO
	
	;SETS VALUE CHANGE FLAG
	BSF		CHANGES_MADE
	;TEST IF UNIT REGISTER EQUALS 9
	MOVLW	.9
	XORWF	REG_UNI,W
	BTFSS	STATUS,Z
	;IF SO, CLEAR UNIT REGISTER AND INCREMENT TENS REGISTER
	GOTO	UNIT_ISNT_NINE
	MOVLW	.9
	XORWF	REG_TENS,W
	BTFSS	STATUS,Z
	GOTO	ONLY_UNIT_IS_NINE
	;IF BOTH REGISTERS ARE 0, CLEAR EVERYTHING
	CLRF	REG_UNI
	CLRF	REG_TENS
	CLRF	TEMPO_CHUVEIRO
	RETURN

	ONLY_UNIT_IS_NINE
	;SOMENTE A UNIDADE E 9 ENTAO ZERA A UNIDADE E INCREMENTA A DEZENA E O REGISTRADOR DE CONTROLE DO DELAY DO CHUVEIRO
	MOVLW	.0
	MOVWF	REG_UNI
	INCF	REG_TENS,F
	INCF	TEMPO_CHUVEIRO,F
	RETURN

	UNIT_ISNT_NINE
	;SE NAO ESTIVER EM 9, APENAS INCREMENTA A UNIDADE
	INCF	TEMPO_CHUVEIRO,F
	INCF	REG_UNI,F
	RETURN

	
;------------------------------------------------------------------------------------------------------------ROTINA DE DECREMENTO NO REGISTRADOR REG_TENS E TEMPO_CHUVEIRO-----------------------;
DECREMENTO

	;SETA A FLAG DE MUDANCA DE VALOR 
	BSF		CHANGES_MADE
	;TESTA SE O VALOR ATUAL DO REGISTRADOR DE UNIDADE EH ZERO
	MOVLW	.0
	XORWF	REG_UNI,W
	BTFSS	STATUS,Z
	GOTO CASO_UNIDADE_NAO_SEJA_0	
	GOTO CASO_UNIDADE_SEJA_0
	
	CASO_UNIDADE_NAO_SEJA_0	
	;SE A UNIDADE NAO EH ZERO, APENAS DECREMENTA UNIDADE E O REGISTRADOR DE CONTROLE DO DELAY DO CHUVEIRO
	DECF	REG_UNI,F
	DECF	TEMPO_CHUVEIRO,F
	RETURN

	;SE FOR 0, TESTA SE A DEZENA TAMBEM EH ZERO
	CASO_UNIDADE_SEJA_0
	MOVLW	.0
	XORWF	REG_TENS,W
	BTFSS	STATUS,Z
	;SE NAO FOR, CONTINUA
	GOTO	$ + 2
	;SE FOR, VAI PARA OUTRA OCASIAO
	GOTO	CASO_OS_DOIS_SEJAM_ZERO
	;COMO SO A UNIDADE EH ZERO, UNIDADE = 9,DEZENA DECREMENTA E O REGISTRADOR DE CONTROLE DO CHUVEIRO TAMBEM
	MOVLW	.9
	MOVWF	REG_UNI
	DECF	REG_TENS,F
	DECF	TEMPO_CHUVEIRO,F
	RETURN
	
	CASO_OS_DOIS_SEJAM_ZERO
	;COMO OS DOIS SAO ZERO, UNIDADE = 9 E DEZENA = 9 E TEMPO_CHUVEIRO = 99
	MOVLW	.9
	MOVWF	REG_UNI
	MOVLW	.9
	MOVWF	REG_TENS
	MOVLW	.99
	MOVWF	TEMPO_CHUVEIRO
	RETURN
	
;---------------------------------------------------------------------------------------------------------------------------------------------ROTINA PRINCIPAL----------------------------------; 
MAIN
	CALL 	ATUALIZA
	BTFSS	MODE_BUTTON
	GOTO 	EXECUCAO
	GOTO 	CONFIGURACAO
;--------------------------------------------------------------------------------------------------------------------------------------------ROTINA DE EXECUCAO---------------------------------;	
EXECUCAO
	
	;SINALIZA QUE ESTA NA ROTINA DE EXECUAO
	BCF		LED_CONFIG
	BSF		LED_RUN

	;TESTA SE FOI APERTADO O BOTAO DE CONFIGURACAO
	BTFSS	MODE_BUTTON
	GOTO 	$ + 5
	;ESPERA QUE O BOTAO SEJA SOLTO
	BTFSS	MODE_BUTTON
	GOTO	$ + 2
	GOTO	$ - 2
	GOTO	CONFIGURACAO


	;TESTA SE O SENSOR DETECTOU CORRENTE
	BTFSS	SENSOR
	;SE NAO, VOLTA PRO INICIO DA ROTINA DE EXECUCAO
	GOTO	EXECUCAO       							    
 	;SE SIM, COMECA O DELAY
	BCF		LED_RUN
	CALL	DELAY	
	BSF		RELAY
	;TEMPO DE COOLDOWN
	CALL	DELAY10S
	BCF		RELAY
	GOTO	EXECUCAO





	;MOSTRA O ESTADO DE FUNCIONAMENTO COM O LED DE EXECUCAO
	BSF		LED_RUN
	;TESTA O PINO DO SENSOR, NAO IRA CONTINUAR A ROTINA SE CASO O SENSOR NAO SER SETADO EM 1
	BTFSS	SENSOR
	GOTO	$ - 2
	;INICIO DA ROTINA DE DELAY ESTIPULADA NA CONFIGURACAO
	CALL	DELAY
	;AO TERMINO DO DELAY, ELE INDICA COM OS DOIS LEDS LIGADOS O TEMPO FALTA 5MIN PARA FEXAR O CIRCUITO DE POTENCIA
	BSF		LED_RUN
	BSF		LED_CONFIG
	;DEPOIS TEMOS O TEMPO DE ESPERA ANTES DE DESLIGAR O CIRCUITO DE POTENCIA
	;CALL	DELAY5S
	;LIGA O PINO ONDE ESTA LIGADO O CIRCUITO DE POTENCIA, FEXANDO O CIRCUITO
	BSF		RELAY
	;TESTA O BOTAO DE START, SE FOR 0, VOLTA PRA EXECUCAO REPETINDO O MESMO CICLO DE ACIONAMENTO
	GOTO	CONFIGURACAO		
	
;--------------------------------------------------------------------------------------------------------------------------------------------ROTINA DE CONFIGURACAO-----------------------------;			
CONFIGURACAO
	;BOTAO CLEAR PARA APAGAR A CONFIGURACAO E RELFAZE-LA
	;BTFSS	CLEAR
	;GOTO	PASSO_0
	;CALL	CLEAR_CONFIG
	
	
	;TESTA NO MEIO DA ROTINA PARA DAR PARTIDA NO TIMER CONFORME A CONFIGURACAO
	;BTFSS	MODE_BUTTON
	;GOTO	PASSO_1
	;GOTO	EXECUCAO

	PASSO_1
	;SINALIZA QUE ESTÁ EM MODO DE CONFIGURAÇÃO
	BSF		LED_CONFIG
	BCF		LED_RUN

	PASSO_2
	;TESTA O BIT DO REGISTRADOR RA4 (BOTAO DE INCREMENTO)SE FOR UM ELE PULA UMA LINHA DA ROTINA
	BTFSS	INC_BUTTON
	GOTO 	PASSO_3
	;ESPERA QUE O BOTAO SEJA SOLTO
	BTFSS	INC_BUTTON
	GOTO	$ + 2
	GOTO	$ - 2
	CALL	INCREMENTO

	PASSO_3
	;TESTA O BIT DO REGISTRADOR RA6 (BOTAO DE DECREMENTO)SE FOR UM ELE PULA UMA LINHA DA ROTINA
	BTFSS	BOTAO_DEC
	GOTO 	PASSO_4
	;ESPERA QUE O BOTAO SEJA SOLTO
	BTFSS	BOTAO_DEC
	GOTO	$ + 2
	GOTO	$ - 2
	CALL	DECREMENTO	

	PASSO_4
	CALL	ATUALIZA
	
	PASSO_5

	BTFSS	MODE_BUTTON
	GOTO 	CONFIGURACAO
	;ESPERA QUE O BOTAO SEJA SOLTO
	BTFSS	MODE_BUTTON
	GOTO	$ + 2
	GOTO	$ - 2
	GOTO	EXECUCAO
			
ATUALIZA
	;ATUALIZA VALOR NO DISPLAY
	
	;TESTA SE ALGUMA MUDANCA OCORREU
	BTFSS	CHANGES_MADE
	;SE NAO APENAS CONTINUA
	RETURN
	;SE SIM ZERA O PORTB PARA QUE SO SEJA NECESSARIO APLICAR MUDANCAS COM BIT = 1
	CLRF	PORTB

	;PRIMEIRA METADE = DISPLAY DA UNIDADE
	BTFSS	REG_UNI,0
	GOTO	$ + 2
	BSF		PORTB,0
	BTFSS	REG_UNI,1
	GOTO	$ + 2
	BSF		PORTB,1
	BTFSS	REG_UNI,2
	GOTO	$ + 2
	BSF		PORTB,2
	BTFSS	REG_UNI,3
	GOTO	$ + 2
	BSF		PORTB,3

	;SEGUNDA METADE = DISPLAY DA DEZENA
	BTFSS	REG_TENS,0
	GOTO	$ + 2
	BSF		PORTB,4
	BTFSS	REG_TENS,1
	GOTO	$ + 2
	BSF		PORTB,5
	BTFSS	REG_TENS,2
	GOTO	$ + 2
	BSF		PORTB,6
	BTFSS	REG_TENS,3
	GOTO	$ + 2
	BSF		PORTB,7
	;LIMPA A FLAG DE MUDANCA DE VALOR, POIS O VALOR FOI ATUALIZADO
	BCF		CHANGES_MADE
	RETURN


	END